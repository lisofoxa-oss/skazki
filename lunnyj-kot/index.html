<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ—É–Ω–Ω—ã–π –∫–æ—Ç ‚Äî –°–∫–∞–∑–∫–∏</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Alegreya:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0b0b14;
            --page-bg: #f5f0e8;
            --page-bg-alt: #f0ead8;
            --ink: #2a2420;
            --ink-light: #5a5248;
            --ink-dim: #9a9080;
            --accent: #8b6914;
            --accent-glow: rgba(201, 168, 76, 0.3);
            --gold: #c9a84c;
            --page-shadow: rgba(0,0,0,0.4);
            --page-w: min(520px, 90vw);
            --page-h: min(700px, 85vh);
        }

        html, body { height: 100%; overflow: hidden; }

        body {
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Alegreya', Georgia, serif;
            user-select: none;
            -webkit-user-select: none;
        }

        /* === BACKGROUND CANVAS === */
        #bgCanvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        /* === BACK LINK === */
        .back-nav {
            position: fixed;
            top: 20px;
            left: 24px;
            z-index: 100;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: rgba(255,255,255,0.3);
            font-family: 'Alegreya', serif;
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            transition: color 0.3s;
        }

        .back-link:hover { color: var(--gold); }
        .back-link svg { width: 14px; height: 14px; }

        /* === BOOK CONTAINER === */
        .book-scene {
            perspective: 1800px;
            position: relative;
            z-index: 1;
            width: var(--page-w);
            height: var(--page-h);
        }

        .book {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        /* === PAGES === */
        .page {
            position: absolute;
            inset: 0;
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
            cursor: pointer;
        }

        .page.flipped {
            transform: rotateY(-180deg);
        }

        .page-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            background: var(--page-bg);
            border-radius: 2px 8px 8px 2px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .page-face.back {
            transform: rotateY(180deg);
            border-radius: 8px 2px 2px 8px;
        }

        /* Page texture overlay */
        .page-face::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 28px,
                    rgba(0,0,0,0.008) 28px,
                    rgba(0,0,0,0.008) 29px
                );
            pointer-events: none;
            z-index: 1;
        }

        /* Page edge shadow */
        .page-face::after {
            content: '';
            position: absolute;
            top: 0;
            width: 30px;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .page-face.front::after {
            right: 0;
            background: linear-gradient(to left, rgba(0,0,0,0.06), transparent);
        }

        .page-face.back::after {
            left: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.06), transparent);
        }

        /* Spine shadow on left */
        .page-face.front {
            box-shadow: inset 8px 0 20px -8px rgba(0,0,0,0.08);
        }
        .page-face.back {
            box-shadow: inset -8px 0 20px -8px rgba(0,0,0,0.08);
        }

        /* === PAGE CONTENT === */
        .page-content {
            flex: 1;
            padding: 40px 36px 24px 44px;
            overflow: hidden;
            position: relative;
        }

        .page-face.back .page-content {
            padding: 40px 44px 24px 36px;
        }

        /* === MARGIN ART CANVAS === */
        .margin-art {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }

        /* === TEXT STYLES === */
        .page-text {
            position: relative;
            z-index: 1;
            color: var(--ink);
            font-size: 1.02rem;
            line-height: 1.82;
        }

        .page-text p {
            margin-bottom: 1.1em;
            text-indent: 1.8em;
            text-align: justify;
            hyphens: auto;
        }

        .page-text p:first-child {
            text-indent: 0;
        }

        .page-text .drop-cap::first-letter {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 4em;
            float: left;
            line-height: 0.75;
            margin-right: 6px;
            margin-top: 8px;
            color: var(--accent);
        }

        .page-text .scene-break {
            text-align: center;
            color: var(--accent);
            font-size: 0.85rem;
            letter-spacing: 10px;
            margin: 1.5em 0;
            text-indent: 0;
        }

        .page-text blockquote {
            margin: 1.2em 0;
            padding: 0.8em 1.5em;
            border-left: 2px solid var(--accent);
            background: rgba(139, 105, 20, 0.04);
            border-radius: 0 6px 6px 0;
            font-style: italic;
            color: var(--ink-light);
            text-indent: 0;
        }

        .page-text h2 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-weight: 400;
            font-size: 1.3rem;
            color: var(--accent);
            text-align: center;
            margin-bottom: 1em;
            text-indent: 0;
            letter-spacing: 0.05em;
        }

        /* === COVER PAGE === */
        .cover-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .cover-emoji {
            font-size: 4rem;
            margin-bottom: 32px;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .cover-title {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-weight: 300;
            font-size: 2.2rem;
            color: var(--ink);
            letter-spacing: 0.06em;
            margin-bottom: 12px;
        }

        .cover-subtitle {
            font-style: italic;
            color: var(--ink-dim);
            font-size: 0.95rem;
            margin-bottom: 48px;
        }

        .cover-ornament {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent);
        }

        .cover-ornament .line {
            width: 50px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .cover-hint {
            margin-top: 60px;
            font-size: 0.75rem;
            color: var(--ink-dim);
            letter-spacing: 0.12em;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* === PAGE NUMBER === */
        .page-number {
            text-align: center;
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 0.8rem;
            color: var(--ink-dim);
            padding: 8px 0 16px;
            letter-spacing: 0.1em;
        }

        /* === NAVIGATION === */
        .nav-bar {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            opacity: 0;
            animation: fadeIn 1s 0.5s ease forwards;
        }

        .nav-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.4);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(201, 168, 76, 0.08);
        }

        .nav-btn:disabled {
            opacity: 0.2;
            cursor: default;
        }

        .nav-btn svg { width: 18px; height: 18px; }

        .nav-info {
            color: rgba(255,255,255,0.25);
            font-size: 0.78rem;
            font-family: 'Cormorant Garamond', serif;
            letter-spacing: 0.1em;
            min-width: 80px;
            text-align: center;
        }

        /* === PROGRESS === */
        .progress-bar {
            position: relative;
            z-index: 10;
            width: var(--page-w);
            height: 2px;
            background: rgba(255,255,255,0.05);
            margin-top: 16px;
            border-radius: 1px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), rgba(201,168,76,0.4));
            border-radius: 1px;
            transition: width 0.5s ease;
        }

        /* === MAGIC PARTICLES ON PAGE TURN === */
        .magic-particle {
            position: fixed;
            pointer-events: none;
            z-index: 50;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--gold);
            animation: particleFly 1s ease-out forwards;
        }

        @keyframes particleFly {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0) translateY(-60px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }

        /* === MOBILE === */
        @media (max-width: 560px) {
            :root {
                --page-w: 96vw;
                --page-h: 80vh;
            }
            .page-content { padding: 28px 20px 16px 24px; }
            .page-face.back .page-content { padding: 28px 24px 16px 20px; }
            .page-text { font-size: 0.92rem; line-height: 1.75; }
            .cover-title { font-size: 1.6rem; }
            .cover-emoji { font-size: 3rem; }
            .back-nav { top: 10px; left: 12px; }
        }
    </style>
</head>
<body>

    <canvas id="bgCanvas"></canvas>

    <nav class="back-nav">
        <a href="../index.html" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M19 12H5M12 18l-6-6 6-6"/>
            </svg>
            –Ω–∞–∑–∞–¥
        </a>
    </nav>

    <div class="book-scene">
        <div class="book" id="book"></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn" id="prevBtn" onclick="prevPage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>
        <span class="nav-info" id="navInfo"></span>
        <button class="nav-btn" id="nextBtn" onclick="nextPage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 18l6-6-6-6"/>
            </svg>
        </button>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <script>
    // ============================================
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ö–ê–ó–ö–ò ‚Äî –º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ
    // ============================================
    const TALE_CONFIG = {
        title: "–õ—É–Ω–Ω—ã–π –∫–æ—Ç",
        emoji: "üåôüê±",
        subtitle: "—Å–∫–∞–∑–∫–∞ –æ —Å–≤–µ—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–ª—å–∑—è —É–∫—Ä–∞—Å—Ç—å",
        // –°—Ç–∏–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–ª–µ–π: "vines", "stars", "geometric", "waves", "fireflies"
        marginStyle: "stars",
        // –¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–æ–≤ –º–∞—Ä–≥–∏–Ω–∞–ª–∏–π
        marginColor: "rgba(139, 105, 20, 0.12)"
    };

    // ============================================
    // –¢–ï–ö–°–¢ –°–ö–ê–ó–ö–ò
    // –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ = –±–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
    // –¢–∏–ø—ã: "p" (–∞–±–∑–∞—Ü), "break" (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å), "quote" (—Ü–∏—Ç–∞—Ç–∞), "h2" (–ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫)
    // –ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç –±—É–∫–≤–∏—Ü—É.
    // ============================================
    const TALE_TEXT = [
        { type: "p", text: "–ñ–∏–ª-–±—ã–ª –∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∂–¥—É—é –Ω–æ—á—å —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ –ª—É–Ω—É –∏ –¥—É–º–∞–ª: ¬´–ï—Å–ª–∏ –±—ã —è –º–æ–≥ –∑–∞–±—Ä–∞—Ç—å –µ—ë —Å–µ–±–µ, –º–Ω–µ –±—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–æ —Ç–µ–º–Ω–æ –∏ –æ–¥–∏–Ω–æ–∫–æ¬ª. –û–Ω –∂–∏–ª –Ω–∞ —Å–∞–º–æ–π –≤—ã—Å–æ–∫–æ–π –∫—Ä—ã—à–µ —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –¥–æ–º–∞ –≤ –≥–æ—Ä–æ–¥–µ, –≥–¥–µ –≤–µ—Ç–µ—Ä –ø–µ–ª –∫–æ–ª—ã–±–µ–ª—å–Ω—ã–µ —á–µ—Ä–µ–ø–∏—Ü–∞–º, –∞ –¥–æ–∂–¥—å —Å—Ç—É—á–∞–ª —Å–≤–æ–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ –¥–∞–ª—ë–∫–∏—Ö –º–æ—Ä—è—Ö." },
        { type: "p", text: "–î—Ä—É–≥–∏–µ –∫–æ—Ç—ã –¥–∞–≤–Ω–æ —Å–ø—É—Å—Ç–∏–ª–∏—Å—å –≤–Ω–∏–∑ ‚Äî –≤ —Ç—ë–ø–ª—ã–µ –∫–æ–º–Ω–∞—Ç—ã, –∫ –±–ª—é–¥—Ü–∞–º —Å –º–æ–ª–æ–∫–æ–º –∏ –º—è–≥–∫–∏–º –∫–æ–ª–µ–Ω—è–º. –û–Ω–∏ –∑–∞–±—ã–ª–∏, –∫–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç –∑–≤—ë–∑–¥—ã –≤–±–ª–∏–∑–∏, –∏ –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ —Å–ª—ã—à–∞—Ç—å, –∫–∞–∫ –ª—É–Ω–∞ —Ç–∏—Ö–æ–Ω—å–∫–æ –≥—É–¥–∏—Ç —Å–≤–æ—é –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –ø–µ—Å–Ω—é. –ù–æ —ç—Ç–æ—Ç –∫–æ—Ç –æ—Å—Ç–∞–≤–∞–ª—Å—è –Ω–∞–≤–µ—Ä—Ö—É." },
        { type: "p", text: "–ï–≥–æ –∑–≤–∞–ª–∏ –ù–∏–≥–¥–µ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–æ–≥–¥–∞ –µ–≥–æ –∏—Å–∫–∞–ª–∏, –æ–Ω –≤—Å–µ–≥–¥–∞ –±—ã–ª –Ω–∏–≥–¥–µ: –Ω–∏ –≤–æ –¥–≤–æ—Ä–µ, –Ω–∏ –≤ –ø–æ–¥–≤–∞–ª–µ, –Ω–∏ –Ω–∞ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–µ. –¢–æ–ª—å–∫–æ –Ω–∞ –∫—Ä—ã—à–µ. –¢–æ–ª—å–∫–æ –Ω–æ—á—å—é. –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω." },
        { type: "break" },
        { type: "p", text: "–û–¥–Ω–∞–∂–¥—ã ‚Äî —ç—Ç–æ –±—ã–ª–æ –≤ —Ç—É –Ω–æ—á—å, –∫–æ–≥–¥–∞ –ª—É–Ω–∞ –≤–∏—Å–µ–ª–∞ —Ç–∞–∫ –Ω–∏–∑–∫–æ, —á—Ç–æ –∫–∞–∑–∞–ª–æ—Å—å, –º–æ–∂–Ω–æ –¥–æ—Ç—è–Ω—É—Ç—å—Å—è –ª–∞–ø–æ–π ‚Äî –ù–∏–≥–¥–µ —Ä–µ—à–∏–ª—Å—è. –û–Ω —Ä–∞–∑–±–µ–∂–∞–ª—Å—è –ø–æ —á–µ—Ä–µ–ø–∏—Ü–∞–º, –æ—Ç—Ç–æ–ª–∫–Ω—É–ª—Å—è –æ—Ç —Å–∞–º–æ–≥–æ –∫—Ä–∞—è –∫—Ä—ã—à–∏ –∏ –ø—Ä—ã–≥–Ω—É–ª –≤–≤–µ—Ä—Ö, –≤ —á—ë—Ä–Ω–æ–µ –±–∞—Ä—Ö–∞—Ç–Ω–æ–µ –Ω–µ–±–æ." },
        { type: "p", text: "–ò —Å–ª—É—á–∏–ª–æ—Å—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ. –û–Ω –Ω–µ —É–ø–∞–ª. –ù–æ—á–Ω–æ–π –≤–æ–∑–¥—É—Ö —Å—Ç–∞–ª –≥—É—Å—Ç—ã–º –∏ —É–ø—Ä—É–≥–∏–º, –∫–∞–∫ –≤–æ–¥–∞, –∏ –∫–æ—Ç –ø–æ–ø–ª—ã–ª –ø–æ –Ω–µ–º—É –≤–≤–µ—Ä—Ö, –∫ –ª—É–Ω–µ, –æ—Å—Ç–∞–≤–ª—è—è –∑–∞ —Å–æ–±–æ–π —Å–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π —Å–ª–µ–¥ –∏–∑ —à–µ—Ä—Å—Ç–∏–Ω–æ–∫, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Å–≤–µ—Ç–∏–ª–∞—Å—å, –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∞—è –∑–≤–µ–∑–¥–∞." },
        { type: "p", text: "–õ—É–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å –≤—Å—ë –±–ª–∏–∂–µ. –û–Ω–∞ –±—ã–ª–∞ –Ω–µ —Ç–∞–∫–æ–π, –∫–∞–∫ –∫–∞–∑–∞–ª–∞—Å—å —Å–Ω–∏–∑—É ‚Äî –Ω–µ —Ö–æ–ª–æ–¥–Ω–æ–π –∏ –Ω–µ –≥–ª–∞–¥–∫–æ–π. –í–±–ª–∏–∑–∏ –ª—É–Ω–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –∫–∞–∫ –æ–≥—Ä–æ–º–Ω—ã–π —Ç—ë–ø–ª—ã–π —Ñ–æ–Ω–∞—Ä—å, —Å–æ—Ç–∫–∞–Ω–Ω—ã–π –∏–∑ —Ç—ã—Å—è—á —Ç–æ–Ω–∫–∏—Ö —Å–≤–µ—Ç—è—â–∏—Ö—Å—è –Ω–∏—Ç–µ–π. –ò –æ—Ç –Ω–µ—ë —à—ë–ª –∑–∞–ø–∞—Ö ‚Äî —Å—Ç—Ä–∞–Ω–Ω—ã–π, —â–µ–º—è—â–∏–π –∑–∞–ø–∞—Ö –º—ë–¥–∞, –ø—ã–ª–∏ –∏ —á–µ–≥–æ-—Ç–æ –∑–∞–±—ã—Ç–æ–≥–æ." },
        { type: "quote", text: "¬´–¢—ã –ø—Ä–∏—à—ë–ª, ‚Äî —Å–∫–∞–∑–∞–ª–∞ –ª—É–Ω–∞. –ì–æ–ª–æ—Å —É –Ω–µ—ë –±—ã–ª –∫–∞–∫ —à—ë–ø–æ—Ç –≤ –ø—É—Å—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ. ‚Äî –Ø –∂–¥–∞–ª–∞. –¢—ã —Ç–∞–∫ –¥–æ–ª–≥–æ —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ –º–µ–Ω—è, —á—Ç–æ —è —Ä–µ—à–∏–ª–∞: –º–æ–∂–µ—Ç –±—ã—Ç—å, —Ç—ã –∑–Ω–∞–µ—à—å —á—Ç–æ-—Ç–æ, —á–µ–≥–æ –Ω–µ –∑–Ω–∞—é—Ç –¥—Ä—É–≥–∏–µ¬ª." },
        { type: "p", text: "¬´–Ø –ø—Ä–∏—à—ë–ª –∑–∞–±—Ä–∞—Ç—å —Ç–µ–±—è¬ª, ‚Äî —Å–∫–∞–∑–∞–ª –ù–∏–≥–¥–µ, –∏ —Å–∞–º —É–¥–∏–≤–∏–ª—Å—è, –∫–∞–∫ —Ç–∏—Ö–æ –∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ —ç—Ç–æ –ø—Ä–æ–∑–≤—É—á–∞–ª–æ –≤ –æ–≥—Ä–æ–º–Ω–æ–π –ø—É—Å—Ç–æ—Ç–µ –º–µ–∂–¥—É –∑–≤—ë–∑–¥." },
        { type: "p", text: "–õ—É–Ω–∞ –Ω–µ —Ä–∞—Å—Å–µ—Ä–¥–∏–ª–∞—Å—å. –û–Ω–∞ –º—è–≥–∫–æ –∑–∞—Å–º–µ—è–ª–∞—Å—å, –∏ –æ—Ç –µ—ë —Å–º–µ—Ö–∞ –ø–æ –Ω–µ–±—É –ø–æ–±–µ–∂–∞–ª–∏ —Å–µ—Ä–µ–±—Ä—è–Ω—ã–µ –∫—Ä—É–≥–∏, –∫–∞–∫ –æ—Ç –∫–∞–º–Ω—è, –±—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –≤ –≤–æ–¥—É." },
        { type: "quote", text: "¬´–ó–∞–±—Ä–∞—Ç—å? –ù–æ –≤–µ–¥—å —è –∏ —Ç–∞–∫ —Ç–≤–æ—è ‚Äî –∫–∞–∂–¥—É—é –Ω–æ—á—å. –†–∞–∑–≤–µ —ç—Ç–æ–≥–æ –º–∞–ª–æ?¬ª" },
        { type: "break" },
        { type: "h2", text: "–ì–ª–∞–≤–∞ –≤—Ç–æ—Ä–∞—è: –¢–µ–Ω—å –±–µ–∑ —Ö–æ–∑—è–∏–Ω–∞" },
        { type: "p", text: "–ù–∏–≥–¥–µ –Ω–µ –∑–Ω–∞–ª, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å. –û–Ω —Å—Ç–æ–ª—å–∫–æ –Ω–æ—á–µ–π –º–µ—á—Ç–∞–ª –æ–± —ç—Ç–æ–º –º–æ–º–µ–Ω—Ç–µ, —á—Ç–æ –∑–∞–±—ã–ª –ø—Ä–∏–¥—É–º–∞—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å, –∫–æ–≥–¥–∞ –º–µ—á—Ç–∞ —Å–±—É–¥–µ—Ç—Å—è. –≠—Ç–æ —á–∞—Å—Ç–æ –±—ã–≤–∞–µ—Ç —Å —Ç–µ–º–∏, –∫—Ç–æ –º–µ—á—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ: –æ–Ω–∏ —Ç–∞–∫ –ø—Ä–∏–≤—ã–∫–∞—é—Ç –∫ –¥–æ—Ä–æ–≥–µ, —á—Ç–æ –∑–∞–±—ã–≤–∞—é—Ç –æ –º–µ—Å—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è." },
        { type: "p", text: "–û–Ω —Å–µ–ª –Ω–∞ –∫—Ä–∞–π –ª—É–Ω—ã, —Å–≤–µ—Å–∏–≤ —Ö–≤–æ—Å—Ç –≤ –ø—É—Å—Ç–æ—Ç—É, –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤–Ω–∏–∑. –ì–æ—Ä–æ–¥ –±—ã–ª –∫—Ä–æ—à–µ—á–Ω—ã–º, –∫–∞–∫ –≥–æ—Ä—Å—Ç—å —Å–≤–µ—Ç—è—â–∏—Ö—Å—è –∫—Ä—É–ø–∏–Ω–æ–∫, –∏ –µ–≥–æ –∫—Ä—ã—à–∞ ‚Äî —Å–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è –∫—Ä—ã—à–∞ —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –¥–æ–º–∞ ‚Äî –±—ã–ª–∞ –µ–¥–≤–∞ –≤–∏–¥–Ω–∞." },
        { type: "p", text: "¬´–ú–æ–∂–Ω–æ –º–Ω–µ –æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å?¬ª ‚Äî —Å–ø—Ä–æ—Å–∏–ª –∫–æ—Ç." },
        { type: "p", text: "¬´–ú–æ–∂–Ω–æ, ‚Äî –æ—Ç–≤–µ—Ç–∏–ª–∞ –ª—É–Ω–∞. ‚Äî –ù–æ —Ç—ã –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å: —Ç–æ—Ç, –∫—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –ª—É–Ω–µ, —Ç–µ—Ä—è–µ—Ç —Å–≤–æ—é —Ç–µ–Ω—å. –û–Ω–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–Ω–∏–∑—É –∏ –∂–∏–≤—ë—Ç –¥–∞–ª—å—à–µ ‚Äî —Ö–æ–¥–∏—Ç –ø–æ —É–ª–∏—Ü–∞–º, –µ—Å—Ç –∏–∑ –±–ª—é–¥–µ—Ü, —Å–ø–∏—Ç –Ω–∞ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–∞—Ö. –ù–æ –æ–Ω–∞ –Ω–µ –ø–æ–º–Ω–∏—Ç, —á—Ç–æ –±—ã–ª–∞ —á—å–µ–π-—Ç–æ —Ç–µ–Ω—å—é. –ò —Ç—ã –Ω–µ –±—É–¥–µ—à—å –ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –æ–Ω–∞ –±—ã–ª–∞ —Ç–≤–æ–µ–π¬ª." },
        { type: "p", text: "–ù–∏–≥–¥–µ –∑–∞–¥—É–º–∞–ª—Å—è. –¢–µ–Ω—å ‚Äî —ç—Ç–æ –≤–µ–¥—å —Ç–æ, —á—Ç–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç —Ç–µ–±—è –∫ –∑–µ–º–ª–µ. –ë–µ–∑ —Ç–µ–Ω–∏ —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å –≥–¥–µ —É–≥–æ–¥–Ω–æ. –ù–æ –±–µ–∑ —Ç–µ–Ω–∏ —Ç—ã –Ω–∏–≥–¥–µ." },
        { type: "p", text: "¬´–Ø –∏ —Ç–∞–∫ –ù–∏–≥–¥–µ¬ª, ‚Äî —Å–∫–∞–∑–∞–ª –∫–æ—Ç –∏ —É–ª—ã–±–Ω—É–ª—Å—è." },
        { type: "p", text: "–õ—É–Ω–∞ –ø–æ–º–æ–ª—á–∞–ª–∞. –ü–æ—Ç–æ–º —Ç–∏—Ö–æ –ø—Ä–æ–∏–∑–Ω–µ—Å–ª–∞:" },
        { type: "quote", text: "¬´–≠—Ç–æ —Å–∞–º–∞—è –≥—Ä—É—Å—Ç–Ω–∞—è —à—É—Ç–∫–∞, –∫–æ—Ç–æ—Ä—É—é —è —Å–ª—ã—à–∞–ª–∞ –∑–∞ —Ç—ã—Å—è—á—É –ª–µ—Ç. –ò —Å–∞–º–∞—è —Å–º–µ–ª–∞—è¬ª." },
        { type: "break" },
        { type: "p", text: "–®–ª–∏ –Ω–æ—á–∏. –ò–ª–∏, –º–æ–∂–µ—Ç –±—ã—Ç—å, –≥–æ–¥—ã ‚Äî –Ω–∞ –ª—É–Ω–µ –≤—Ä–µ–º—è —É—Å—Ç—Ä–æ–µ–Ω–æ –∏–Ω–∞—á–µ, –æ–Ω–æ —Ç–µ—á—ë—Ç –Ω–µ –≤–ø–µ—Ä—ë–¥, –∞ –≤–≥–ª—É–±—å, –∫–∞–∫ –∫–æ—Ä–Ω–∏ –¥–µ—Ä–µ–≤–∞. –ù–∏–≥–¥–µ –ª–µ–∂–∞–ª –Ω–∞ —Ç—ë–ø–ª–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –ª—É–Ω—ã, –∏ –æ–Ω–∞ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∞ –µ–º—É –∏—Å—Ç–æ—Ä–∏–∏." },
        { type: "p", text: "–û–Ω–∞ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∞ –æ –ø–µ—Ä–≤–æ–º —á–µ–ª–æ–≤–µ–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤–≤–µ—Ä—Ö –∏ –∑–∞–ø–ª–∞–∫–∞–ª –æ—Ç –∫—Ä–∞—Å–æ—Ç—ã. –û –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≥–∞–¥—ã–≤–∞–ª–∏ –∂–µ–ª–∞–Ω–∏—è. –û –ø–æ—ç—Ç–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—Å–∞–ª–∏ –æ –Ω–µ–π —Å—Ç–∏—Ö–∏, –Ω–µ –∑–Ω–∞—è, —á—Ç–æ –æ–Ω–∞ –∏—Ö —Å–ª—ã—à–∏—Ç. –û –ø—Ä–∏–ª–∏–≤–∞—Ö –∏ –æ—Ç–ª–∏–≤–∞—Ö ‚Äî –æ —Ç–æ–º, –∫–∞–∫ –æ–∫–µ–∞–Ω—ã —Ç—è–Ω—É—Ç—Å—è –∫ –Ω–µ–π, —Å–ª–æ–≤–Ω–æ –¥–µ—Ç–∏ –∫ –º–∞—Ç–µ—Ä–∏." },
        { type: "p", text: "¬´–ê –æ–±–æ –º–Ω–µ –∫—Ç–æ-–Ω–∏–±—É–¥—å –¥—É–º–∞–µ—Ç?¬ª ‚Äî —Å–ø—Ä–æ—Å–∏–ª –æ–¥–Ω–∞–∂–¥—ã –ù–∏–≥–¥–µ." },
        { type: "p", text: "–õ—É–Ω–∞ –ø–æ—Å–≤–µ—Ç–∏–ª–∞ —á—É—Ç—å —è—Ä—á–µ, –∏ –≤ –µ—ë —Å–≤–µ—Ç–µ –∫–æ—Ç —É–≤–∏–¥–µ–ª –¥–∞–ª–µ–∫–æ –≤–Ω–∏–∑—É ‚Äî –Ω–∞ –∫—Ä—ã—à–µ —Å—Ç–∞—Ä–æ–≥–æ –¥–æ–º–∞ ‚Äî —Å–≤–æ—é —Ç–µ–Ω—å. –û–Ω–∞ —Å–∏–¥–µ–ª–∞ —Ç–∞–º, –≥–¥–µ –æ–Ω –ª—é–±–∏–ª —Å–∏–¥–µ—Ç—å, –∏ —Å–º–æ—Ç—Ä–µ–ª–∞ –≤–≤–µ—Ä—Ö. –ù–æ –æ–Ω–∞ –Ω–µ –≤–∏–¥–µ–ª–∞ –ª—É–Ω—É. –û–Ω–∞ –≤–∏–¥–µ–ª–∞ –ø—Ä–æ—Å—Ç–æ —Å–≤–µ—Ç–ª–æ–µ –ø—è—Ç–Ω–æ –≤ –Ω–µ–±–µ." },
        { type: "p", text: "¬´–û–Ω–∞ –∫–∞–∂–¥—É—é –Ω–æ—á—å –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—é–¥–∞, ‚Äî —Å–∫–∞–∑–∞–ª–∞ –ª—É–Ω–∞. ‚Äî –û–Ω–∞ –Ω–µ –ø–æ–º–Ω–∏—Ç —Ç–µ–±—è. –ù–æ —á—Ç–æ-—Ç–æ –≤ –Ω–µ–π –ø–æ–º–Ω–∏—Ç. –ß—Ç–æ-—Ç–æ, —É —á–µ–≥–æ –Ω–µ—Ç –∏–º–µ–Ω–∏¬ª." },
        { type: "p", text: "–ò —Ç–æ–≥–¥–∞ –ù–∏–≥–¥–µ –≤–ø–µ—Ä–≤—ã–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª, —á—Ç–æ –∑–Ω–∞—á–∏—Ç –±—ã—Ç—å –ª—É–Ω–æ–π ‚Äî –≤–∏–¥–µ—Ç—å –≤—Å–µ—Ö, —Å–≤–µ—Ç–∏—Ç—å –≤—Å–µ–º –∏ –Ω–∏ –∫ –∫–æ–º—É –Ω–µ –º–æ—á—å –ø—Ä–∏–∫–æ—Å–Ω—É—Ç—å—Å—è." },
        { type: "break" },
        { type: "h2", text: "–ì–ª–∞–≤–∞ —Ç—Ä–µ—Ç—å—è: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ" },
        { type: "p", text: "¬´–Ø —Ö–æ—á—É –≤–µ—Ä–Ω—É—Ç—å—Å—è¬ª, ‚Äî —Å–∫–∞–∑–∞–ª –∫–æ—Ç." },
        { type: "p", text: "–õ—É–Ω–∞ –≤–∑–¥–æ—Ö–Ω—É–ª–∞. –û—Ç –µ—ë –≤–∑–¥–æ—Ö–∞ –ø–æ–≥–∞—Å–ª–∏ —Ç—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∑–≤–µ–∑–¥—ã –∏ —Ç—É—Ç –∂–µ –∑–∞–∂–≥–ª–∏—Å—å —Å–Ω–æ–≤–∞." },
        { type: "quote", text: "¬´–Ø –∑–Ω–∞–ª–∞, —á—Ç–æ —Ç—ã —ç—Ç–æ —Å–∫–∞–∂–µ—à—å. –í—Å–µ —Ç–∞–∫ –≥–æ–≤–æ—Ä—è—Ç ‚Äî —Ä–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ. –¢–µ, –∫—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–æ –º–Ω–µ, –≤—Å–µ–≥–¥–∞ —É—Ö–æ–¥—è—Ç. –¢–∞–∫–æ–≤–∞ –º–æ—è —Å—É–¥—å–±–∞ ‚Äî –±—ã—Ç—å —Å–≤–µ—Ç–æ–º, –∫ –∫–æ—Ç–æ—Ä–æ–º—É —Å—Ç—Ä–µ–º—è—Ç—Å—è, –∏ –º–µ—Å—Ç–æ–º, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∫–∏–¥–∞—é—Ç¬ª." },
        { type: "p", text: "¬´–ú–Ω–µ –∂–∞–ª—å¬ª, ‚Äî –ø—Ä–æ—à–µ–ø—Ç–∞–ª –ù–∏–≥–¥–µ." },
        { type: "p", text: "¬´–ù–µ –Ω–∞–¥–æ. –¢—ã –Ω–∞—É—á–∏–ª –º–µ–Ω—è –∫–æ–µ-—á–µ–º—É –≤–∞–∂–Ω–æ–º—É. –Ø –≤—Å–µ–≥–¥–∞ –¥—É–º–∞–ª–∞, —á—Ç–æ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ —Ç—ã –æ–¥–∏–Ω. –ù–æ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ —Ä—è–¥–æ–º –µ—Å—Ç—å —Ç–æ—Ç, –∫—Ç–æ —Å–∫–æ—Ä–æ —É–π–¥—ë—Ç, –∏ —Ç—ã —É–∂–µ —á—É–≤—Å—Ç–≤—É–µ—à—å –ø—É—Å—Ç–æ—Ç—É –∑–∞—Ä–∞–Ω–µ–µ. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–∫–∞–∑–∞–ª –º–Ω–µ —ç—Ç–æ¬ª." },
        { type: "p", text: "–ù–∏–≥–¥–µ –Ω–µ –∑–Ω–∞–ª, –±–ª–∞–≥–æ–¥–∞—Ä—è—Ç –µ–≥–æ –∏–ª–∏ —É–ø—Ä–µ–∫–∞—é—Ç. –ù–∞ –ª—É–Ω–µ –∏ —ç—Ç–æ —É—Å—Ç—Ä–æ–µ–Ω–æ –∏–Ω–∞—á–µ ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ –±–æ–ª—å —Å–¥–µ–ª–∞–Ω—ã –∏–∑ –æ–¥–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞." },
        { type: "p", text: "–û–Ω –ø—Ä—ã–≥–Ω—É–ª –≤–Ω–∏–∑. –ü–∞–¥–µ–Ω–∏–µ –±—ã–ª–æ –¥–æ–ª–≥–∏–º –∏ –º—è–≥–∫–∏–º, –∫–∞–∫ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ —Å–æ–Ω, –∏ –∫–æ–≥–¥–∞ –æ–Ω –ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è –Ω–∞ —Å–≤–æ—é –∫—Ä—ã—à—É, –æ–Ω –Ω–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª —É–¥–∞—Ä–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–ø–ª–æ —á–µ—Ä–µ–ø–∏—Ü—ã –ø–æ–¥ –ª–∞–ø–∞–º–∏ –∏ —Ç—è–∂–µ—Å—Ç—å —Ç–µ–Ω–∏, –∫–æ—Ç–æ—Ä–∞—è —Ç—É—Ç –∂–µ –≤–µ—Ä–Ω—É–ª–∞—Å—å –∫ –Ω–µ–º—É, –ø—Ä–∏–∂–∞–ª–∞—Å—å, –∫–∞–∫ –∫–æ—Ç—ë–Ω–æ–∫, –∏ –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–ø—É—Å–∫–∞–ª–∞." },
        { type: "break" },
        { type: "p", text: "–° —Ç–µ—Ö –ø–æ—Ä –ù–∏–≥–¥–µ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Å–∏–¥–∏—Ç –Ω–∞ –∫—Ä—ã—à–µ –∫–∞–∂–¥—É—é –Ω–æ—á—å. –û–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –ª—É–Ω—É, –∏ –ª—É–Ω–∞ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –Ω–µ–≥–æ. –û–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—é—Ç ‚Äî –∏–º —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ. –ï—Å—Ç—å –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–Ω—è—Ç–Ω—ã –±–µ–∑ —Å–ª–æ–≤, –∏ –≥–ª–∞–≤–Ω–∞—è –∏–∑ –Ω–∏—Ö: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –Ω–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏—Ö –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—Ç—å, –∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –±—ã–ª–æ –º–µ—Å—Ç–æ –¥–ª—è —Å–≤–µ—Ç–∞." },
        { type: "p", text: "–ê —Ç–µ–Ω—å –µ–≥–æ —Å—Ç–∞–ª–∞ —Å—Ç—Ä–∞–Ω–Ω–æ–π ‚Äî —Å–µ—Ä–µ–±—Ä–∏—Å—Ç–æ–π –ø–æ –∫—Ä–∞—è–º, –±—É–¥—Ç–æ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–π –∏–∑–Ω—É—Ç—Ä–∏. –ò –∫–æ–≥–¥–∞ –¥–µ—Ç–∏ –∑–∞–º–µ—á–∞–ª–∏ —ç—Ç—É —Ç–µ–Ω—å –Ω–∞ —Ç—Ä–æ—Ç—É–∞—Ä–µ, –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å –∏ —Å–º–æ—Ç—Ä–µ–ª–∏ –≤–≤–µ—Ä—Ö." },
        { type: "p", text: "–û–Ω–∏ –Ω–µ –∑–Ω–∞–ª–∏, –ø–æ—á–µ–º—É. –ù–æ —á—Ç–æ-—Ç–æ –≤ –Ω–∏—Ö –ø–æ–º–Ω–∏–ª–æ." }
    ];

    // ============================================
    // –î–í–ò–ñ–û–ö –ö–ù–ò–ì–ò (–Ω–µ —Ç—Ä–æ–≥–∞—Ç—å)
    // ============================================

    const book = document.getElementById('book');
    const navInfo = document.getElementById('navInfo');
    const progressFill = document.getElementById('progressFill');
    let pages = [];
    let currentPage = 0;
    let totalPages = 0;

    // --- Paginate text to fit pages ---
    function buildBook() {
        book.innerHTML = '';
        pages = [];

        // Cover page
        const coverHtml = `
            <div class="cover-content">
                <span class="cover-emoji">${TALE_CONFIG.emoji}</span>
                <h1 class="cover-title">${TALE_CONFIG.title}</h1>
                <p class="cover-subtitle">${TALE_CONFIG.subtitle || ''}</p>
                <div class="cover-ornament">
                    <span class="line"></span>
                    <span style="font-size:12px">‚ú¶</span>
                    <span class="line"></span>
                </div>
                <p class="cover-hint">–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å ‚Üí</p>
            </div>`;

        // Convert tale text to HTML blocks
        const blocks = TALE_TEXT.map((item, idx) => {
            switch(item.type) {
                case 'p':
                    const cls = idx === 0 ? ' class="drop-cap"' : '';
                    return `<p${cls}>${item.text}</p>`;
                case 'break':
                    return '<p class="scene-break">‚ú¶ ‚ú¶ ‚ú¶</p>';
                case 'quote':
                    return `<blockquote>${item.text}</blockquote>`;
                case 'h2':
                    return `<h2>${item.text}</h2>`;
                default:
                    return `<p>${item.text}</p>`;
            }
        });

        // Measure and paginate
        const measurer = document.createElement('div');
        measurer.style.cssText = `
            position: absolute; visibility: hidden; pointer-events: none;
            width: calc(var(--page-w) - 80px); font-family: Alegreya, Georgia, serif;
            font-size: 1.02rem; line-height: 1.82;
        `;
        document.body.appendChild(measurer);

        const pageHeight = Math.min(700, window.innerHeight * 0.85) - 80;
        const contentPages = [];
        let currentContent = [];
        let currentHeight = 0;

        blocks.forEach((blockHtml) => {
            measurer.innerHTML = blockHtml;
            const blockHeight = measurer.offsetHeight + 18;

            if (currentHeight + blockHeight > pageHeight && currentContent.length > 0) {
                contentPages.push(currentContent.join(''));
                currentContent = [blockHtml];
                currentHeight = blockHeight;
            } else {
                currentContent.push(blockHtml);
                currentHeight += blockHeight;
            }
        });

        if (currentContent.length > 0) {
            contentPages.push(currentContent.join(''));
        }

        document.body.removeChild(measurer);

        // Build page pairs (front + back)
        // Each physical page has 2 sides
        const allSides = [coverHtml, ...contentPages.map(html =>
            `<div class="page-text">${html}</div>`
        )];

        // Add final page
        allSides.push(`
            <div class="cover-content">
                <div class="cover-ornament" style="margin-bottom: 32px;">
                    <span class="line"></span>
                    <span style="font-size:12px">‚ú¶</span>
                    <span class="line"></span>
                </div>
                <p class="cover-subtitle" style="font-size: 1.1rem;">–∫–æ–Ω–µ—Ü</p>
                <p class="cover-subtitle" style="margin-top: 24px; font-size: 0.85rem;">
                    ${TALE_CONFIG.title}
                </p>
            </div>
        `);

        // Pad to even
        if (allSides.length % 2 !== 0) allSides.push('');

        totalPages = allSides.length / 2;

        for (let i = 0; i < totalPages; i++) {
            const pageEl = document.createElement('div');
            pageEl.className = 'page';
            pageEl.style.zIndex = totalPages - i;

            const frontContent = allSides[i * 2];
            const backContent = allSides[i * 2 + 1];

            const frontNum = i * 2;
            const backNum = i * 2 + 1;

            pageEl.innerHTML = `
                <div class="page-face front">
                    <canvas class="margin-art" data-page="${frontNum}"></canvas>
                    <div class="page-content">${frontContent}</div>
                    ${frontNum > 0 ? `<div class="page-number">${frontNum}</div>` : ''}
                </div>
                <div class="page-face back">
                    <canvas class="margin-art" data-page="${backNum}"></canvas>
                    <div class="page-content">${backContent}</div>
                    <div class="page-number">${backNum}</div>
                </div>
            `;

            pageEl.addEventListener('click', () => {
                if (i >= currentPage) nextPage();
                else prevPage();
            });

            book.appendChild(pageEl);
            pages.push(pageEl);
        }

        updateNav();
        drawAllMarginArt();
    }

    function nextPage() {
        if (currentPage >= totalPages - 1) return;
        pages[currentPage].classList.add('flipped');
        currentPage++;
        updateNav();
        spawnMagicParticles();
    }

    function prevPage() {
        if (currentPage <= 0) return;
        currentPage--;
        pages[currentPage].classList.remove('flipped');
        updateNav();
        spawnMagicParticles();
    }

    function updateNav() {
        const total = totalPages;
        navInfo.textContent = `${currentPage + 1} / ${total}`;
        document.getElementById('prevBtn').disabled = currentPage <= 0;
        document.getElementById('nextBtn').disabled = currentPage >= total - 1;
        progressFill.style.width = ((currentPage + 1) / total * 100) + '%';

        // Update z-indices
        pages.forEach((p, i) => {
            if (i < currentPage) {
                p.style.zIndex = i;
            } else {
                p.style.zIndex = totalPages - i;
            }
        });
    }

    // Keyboard
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextPage(); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); prevPage(); }
    });

    // Touch swipe
    let touchStartX = 0;
    document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
    document.addEventListener('touchend', e => {
        const diff = touchStartX - e.changedTouches[0].clientX;
        if (Math.abs(diff) > 50) {
            if (diff > 0) nextPage(); else prevPage();
        }
    });

    // ============================================
    // MAGIC PARTICLES
    // ============================================
    function spawnMagicParticles() {
        const rect = book.getBoundingClientRect();
        const x = rect.left + rect.width * 0.1;
        const count = 8 + Math.random() * 6;

        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'magic-particle';
            p.style.left = (x + Math.random() * 30 - 15) + 'px';
            p.style.top = (rect.top + Math.random() * rect.height) + 'px';
            p.style.width = (2 + Math.random() * 3) + 'px';
            p.style.height = p.style.width;
            p.style.animationDuration = (0.6 + Math.random() * 0.8) + 's';
            p.style.background = Math.random() > 0.5 ?
                'var(--gold)' :
                'rgba(255, 255, 255, 0.6)';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1200);
        }
    }

    // ============================================
    // MARGIN ART (Canvas decorations)
    // ============================================
    function drawAllMarginArt() {
        document.querySelectorAll('.margin-art').forEach(canvas => {
            const page = parseInt(canvas.dataset.page);
            if (page === 0) return; // skip cover
            const rect = canvas.parentElement;
            canvas.width = rect.offsetWidth;
            canvas.height = rect.offsetHeight;
            drawMarginArt(canvas, page);
        });
    }

    function drawMarginArt(canvas, pageNum) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const style = TALE_CONFIG.marginStyle;
        const color = TALE_CONFIG.marginColor;

        // Seed based on page number for consistency
        const seed = pageNum * 137.5;
        const rand = (i) => {
            const x = Math.sin(seed + i * 9.8) * 10000;
            return x - Math.floor(x);
        };

        if (style === 'stars') {
            // Tiny stars and constellations on margins
            ctx.fillStyle = color;
            for (let i = 0; i < 25; i++) {
                const x = rand(i) > 0.5 ?
                    rand(i + 100) * 40 + 10 :
                    w - rand(i + 200) * 40 - 10;
                const y = rand(i + 50) * h;
                const size = 1 + rand(i + 75) * 2.5;
                ctx.globalAlpha = 0.15 + rand(i + 30) * 0.2;
                ctx.beginPath();
                drawStar(ctx, x, y, size, 4);
                ctx.fill();
            }
            // Constellation lines
            ctx.strokeStyle = color;
            ctx.lineWidth = 0.5;
            ctx.globalAlpha = 0.08;
            for (let i = 0; i < 4; i++) {
                const startX = rand(i + 300) > 0.5 ? rand(i + 310) * 30 + 5 : w - rand(i + 320) * 30 - 5;
                const startY = rand(i + 330) * h * 0.8 + h * 0.1;
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                for (let j = 1; j <= 3; j++) {
                    ctx.lineTo(
                        startX + (rand(i + j * 10 + 400) - 0.5) * 30,
                        startY + j * 25 + rand(i + j * 10 + 500) * 15
                    );
                }
                ctx.stroke();
            }

            // Moon crescent on some pages
            if (pageNum % 4 === 1) {
                ctx.globalAlpha = 0.06;
                ctx.fillStyle = color;
                const mx = pageNum % 2 === 0 ? 30 : w - 30;
                const my = 50 + rand(pageNum) * 40;
                ctx.beginPath();
                ctx.arc(mx, my, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(mx + 6, my - 3, 13, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        if (style === 'vines') {
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.2;
            ctx.globalAlpha = 0.15;

            // Vine on one side
            const side = pageNum % 2 === 0 ? 'left' : 'right';
            const baseX = side === 'left' ? 18 : w - 18;

            ctx.beginPath();
            ctx.moveTo(baseX, h * 0.05);
            for (let y = h * 0.05; y < h * 0.95; y += 4) {
                const wave = Math.sin(y * 0.015 + seed) * 8;
                ctx.lineTo(baseX + wave, y);
            }
            ctx.stroke();

            // Leaves
            for (let i = 0; i < 8; i++) {
                const ly = h * 0.1 + (h * 0.8 / 8) * i + rand(i + 600) * 30;
                const wave = Math.sin(ly * 0.015 + seed) * 8;
                const lx = baseX + wave;
                const dir = side === 'left' ? 1 : -1;
                ctx.globalAlpha = 0.08 + rand(i + 700) * 0.08;
                ctx.beginPath();
                ctx.ellipse(lx + dir * 8, ly, 6, 3, dir * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
            }
        }

        if (style === 'geometric') {
            ctx.strokeStyle = color;
            ctx.lineWidth = 0.8;
            ctx.globalAlpha = 0.08;

            // Corner ornaments
            const corners = [[0, 0], [w, 0], [0, h], [w, h]];
            corners.forEach(([cx, cy], ci) => {
                ctx.save();
                ctx.translate(cx, cy);
                const scaleX = cx === 0 ? 1 : -1;
                const scaleY = cy === 0 ? 1 : -1;
                ctx.scale(scaleX, scaleY);
                ctx.beginPath();
                ctx.moveTo(5, 30);
                ctx.lineTo(5, 5);
                ctx.lineTo(30, 5);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(12, 12, 3, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            });

            // Subtle diamonds scattered
            for (let i = 0; i < 6; i++) {
                const dx = rand(i + 800) > 0.5 ?
                    rand(i + 810) * 25 + 8 :
                    w - rand(i + 820) * 25 - 8;
                const dy = rand(i + 830) * h * 0.7 + h * 0.15;
                const size = 3 + rand(i + 840) * 4;
                ctx.globalAlpha = 0.05 + rand(i + 850) * 0.06;
                ctx.beginPath();
                ctx.moveTo(dx, dy - size);
                ctx.lineTo(dx + size * 0.6, dy);
                ctx.lineTo(dx, dy + size);
                ctx.lineTo(dx - size * 0.6, dy);
                ctx.closePath();
                ctx.stroke();
            }
        }

        if (style === 'waves') {
            ctx.strokeStyle = color;
            ctx.lineWidth = 0.8;

            for (let i = 0; i < 3; i++) {
                ctx.globalAlpha = 0.04 + i * 0.02;
                ctx.beginPath();
                const baseY = h - 40 - i * 15;
                for (let x = 0; x <= w; x += 2) {
                    const y = baseY + Math.sin(x * 0.02 + seed + i) * 6;
                    x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }

        if (style === 'fireflies') {
            for (let i = 0; i < 15; i++) {
                const fx = rand(i + 900) * w;
                const fy = rand(i + 950) * h;
                const size = 1.5 + rand(i + 960) * 2;
                const alpha = 0.05 + rand(i + 970) * 0.1;

                ctx.globalAlpha = alpha;
                ctx.fillStyle = '#c9a84c';
                ctx.beginPath();
                ctx.arc(fx, fy, size, 0, Math.PI * 2);
                ctx.fill();

                // Glow
                ctx.globalAlpha = alpha * 0.3;
                ctx.beginPath();
                ctx.arc(fx, fy, size * 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        ctx.globalAlpha = 1;
    }

    function drawStar(ctx, cx, cy, r, points) {
        ctx.moveTo(cx, cy - r);
        for (let i = 0; i < points * 2; i++) {
            const radius = i % 2 === 0 ? r : r * 0.4;
            const angle = (i * Math.PI) / points - Math.PI / 2;
            ctx.lineTo(cx + Math.cos(angle) * radius, cy + Math.sin(angle) * radius);
        }
        ctx.closePath();
    }

    // ============================================
    // BACKGROUND STARS
    // ============================================
    (function initBg() {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let stars = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 120; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: 0.5 + Math.random() * 1.5,
                    alpha: Math.random(),
                    speed: 0.002 + Math.random() * 0.008,
                    phase: Math.random() * Math.PI * 2
                });
            }
        }

        function draw(t) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(s => {
                s.alpha = 0.15 + 0.35 * (0.5 + 0.5 * Math.sin(t * s.speed + s.phase));
                ctx.globalAlpha = s.alpha;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                ctx.fill();
            });

            // Subtle moon glow top-right
            ctx.globalAlpha = 0.03;
            const grd = ctx.createRadialGradient(
                canvas.width * 0.85, canvas.height * 0.1, 10,
                canvas.width * 0.85, canvas.height * 0.1, 200
            );
            grd.addColorStop(0, 'rgba(201, 168, 76, 0.5)');
            grd.addColorStop(1, 'transparent');
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.globalAlpha = 1;
            requestAnimationFrame(draw);
        }

        window.addEventListener('resize', () => { resize(); });
        resize();
        requestAnimationFrame(draw);
    })();

    // Init
    buildBook();
    window.addEventListener('resize', () => {
        buildBook();
    });
    </script>
</body>
</html>
